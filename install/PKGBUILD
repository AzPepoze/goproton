# Maintainer: AzPepoze
pkgname=goproton
pkgver=r0.git
pkgrel=1
pkgdesc="Proton Instance Manager for Linux - Run Windows games with umu-run"
arch=('x86_64')
url="https://github.com/AzPepoze/goproton"
license=('MIT')
depends=('umu-launcher' 'steam' 'webkit2gtk-4.1' 'gtk3' 'libayatana-appindicator')
makedepends=('go' 'pnpm' 'git')
optdepends=('protonplus: recommended for managing Proton versions')
source=("$pkgname::git+https://github.com/AzPepoze/goproton.git#branch=main")
sha256sums=('SKIP')

pkgver() {
	cd "$srcdir/$pkgname"
	# Get version from git tags/commits
	printf "r%s.g%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
	cd "$srcdir/$pkgname"
	# Ensure Wails v3 is installed for the build process
	export GOPATH="${BUILDDIR}/go"
	export PATH="${GOPATH}/bin:$PATH"
	go install github.com/wailsapp/wails/v3/cmd/wails@latest
}

build() {
	cd "$srcdir/$pkgname"
	
	# Set isolated build environment
	export GOPATH="${BUILDDIR}/go"
	export PATH="${GOPATH}/bin:$PATH"
	
	# Build using the modernized Makefile and Wails v3
	make dist
}

package() {
	cd "$srcdir/$pkgname"
	
	# Use the dist folder structure created by 'make dist'
	cp -r dist/linux/* "$pkgdir/usr/"
	
	# Install license
	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	
	# Install documentation
	install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
}

post_install() {
	echo "==> GoProton installed successfully!"
	echo "==> To launch the UI, run: goproton"
	echo ""
	echo "==> Make sure to install umu-launcher and Steam first:"
	echo "    $ sudo pacman -S umu-launcher steam"
}

post_upgrade() {
	echo "==> GoProton upgraded successfully!"
	echo "==> Run 'goproton' to start the launcher"
}