version: '3'

tasks:
     go:mod:tidy:
          summary: Runs `go mod tidy`
          internal: true
          cmds:
             - go mod tidy

     install:frontend:deps:
          summary: Install frontend dependencies
          dir: frontend
          sources:
             - package.json
             - pnpm-lock.yaml
          generates:
             - node_modules
          preconditions:
             - sh: pnpm --version
               msg: "Looks like pnpm isn't installed."
          cmds:
             - pnpm install

     build:frontend:
          label: build:frontend (DEV={{.DEV}})
          summary: Build the frontend project
          dir: frontend
          sources:
             - "**/*"
          generates:
             - dist/**/*
          deps:
             - task: install:frontend:deps
             - task: generate:bindings
               vars:
                    BUILD_FLAGS:
                         ref: .BUILD_FLAGS
          cmds:
             - pnpm run {{.BUILD_COMMAND}}
          env:
               PRODUCTION: '{{if eq .DEV "true"}}false{{else}}true{{end}}'
          vars:
               BUILD_COMMAND: '{{if eq .DEV "true"}}build:dev{{else}}build{{end}}'

     generate:bindings:
          label: generate:bindings (BUILD_FLAGS={{.BUILD_FLAGS}})
          summary: Generates bindings for the frontend
          deps:
             - task: go:mod:tidy
          sources:
             - "**/*.[jt]s"
             - exclude: frontend/**/*
             - frontend/bindings/**/* # Rerun when switching between dev/production mode causes changes in output
             - "**/*.go"
             - go.mod
             - go.sum
          generates:
             - frontend/bindings/**/*
          cmds:
             - wails3 generate bindings -f '{{.BUILD_FLAGS}}' -clean=true -ts

     dev:frontend:
          summary: Runs the frontend in development mode
          dir: frontend
          deps:
             - task: install:frontend:deps
          cmds:
             - pnpm run dev --port {{.VITE_PORT}} --strictPort