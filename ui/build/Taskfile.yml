version: '3'

tasks:
     go:mod:tidy:
          summary: Runs `go mod tidy`
          internal: true
          cmds:
             - go mod tidy

     install:frontend:deps:
          summary: Install frontend dependencies
          dir: frontend
          sources:
             - package.json
             - pnpm-lock.yaml
          generates:
             - node_modules
          preconditions:
             - sh: pnpm --version
               msg: "Looks like pnpm isn't installed."
          cmds:
             - pnpm install

     build:frontend:
          label: build:frontend (DEV={{.DEV}})
          summary: Build the frontend project
          dir: frontend
          sources:
             - "**/*"
          generates:
             - dist/**/*
          deps:
             - task: install:frontend:deps
             - task: generate:bindings
               vars:
                    BUILD_FLAGS:
                         ref: .BUILD_FLAGS
          cmds:
             - pnpm run {{.BUILD_COMMAND}}
          env:
               PRODUCTION: '{{if eq .DEV "true"}}false{{else}}true{{end}}'
          vars:
               BUILD_COMMAND: '{{if eq .DEV "true"}}build:dev{{else}}build{{end}}'

     generate:bindings:
          label: generate:bindings (BUILD_FLAGS={{.BUILD_FLAGS}})
          summary: Generates bindings for the frontend
          deps:
             - task: go:mod:tidy
          sources:
             - "**/*.[jt]s"
             - exclude: frontend/**/*
             - frontend/bindings/**/* # Rerun when switching between dev/production mode causes changes in output
             - "**/*.go"
             - go.mod
             - go.sum
          generates:
             - frontend/bindings/**/*
          cmds:
             - wails3 generate bindings -f '{{.BUILD_FLAGS}}' -clean=true -ts

     generate:icons:
          summary: Generates Windows `.ico` from an image.
          dir: build
          sources:
             - "appicon.png"
          generates:
             - "windows/icon.ico"
          cmds:
             - wails3 generate icons -input appicon.png -windowsfilename windows/icon.ico

     dev:frontend:
          summary: Runs the frontend in development mode
          dir: frontend
          deps:
             - task: install:frontend:deps
          cmds:
             - pnpm run dev --port {{.VITE_PORT}} --strictPort

     build:server:
          summary: Builds the application in server mode (no GUI, HTTP server only)
          desc: |
               Builds the application with the server build tag enabled.
               Server mode runs as a pure HTTP server without native GUI dependencies.
               Usage: task build:server
          deps:
             - task: build:frontend
               vars:
                    BUILD_FLAGS:
                         ref: .BUILD_FLAGS
          cmds:
             - go build -tags server {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}-server{{exeExt}}
          vars:
               BUILD_FLAGS: "{{.BUILD_FLAGS}}"

     run:server:
          summary: Builds and runs the application in server mode
          deps:
             - task: build:server
          cmds:
             - ./{{.BIN_DIR}}/{{.APP_NAME}}-server{{exeExt}}

     build:docker:
          summary: Builds a Docker image for server mode deployment
          desc: |
               Creates a minimal Docker image containing the server mode binary.
               The image is based on distroless for security and small size.
               Usage: task build:docker [TAG=myapp:latest]
          cmds:
             - docker build -t {{.TAG | default (printf "%s:latest" .APP_NAME)}} -f build/docker/Dockerfile.server .
          vars:
               TAG: "{{.TAG}}"
          preconditions:
             - sh: docker info > /dev/null 2>&1
               msg: "Docker is required. Please install Docker first."
             - sh: test -f build/docker/Dockerfile.server
               msg: "Dockerfile.server not found. Run 'wails3 update build-assets' to generate it."

     run:docker:
          summary: Builds and runs the Docker image
          desc: |
               Builds the Docker image and runs it, exposing port 8080.
               Usage: task run:docker [TAG=myapp:latest] [PORT=8080]
               Note: The internal container port is always 8080. The PORT variable
               only changes the host port mapping. Ensure your app uses port 8080
               or modify the Dockerfile to match your ServerOptions.Port setting.
          deps:
             - task: build:docker
               vars:
                    TAG:
                         ref: .TAG
          cmds:
             - docker run --rm -p {{.PORT | default "8080"}}:8080 {{.TAG | default (printf "%s:latest" .APP_NAME)}}
          vars:
               TAG: "{{.TAG}}"
               PORT: "{{.PORT}}"

     setup:docker:
          summary: Builds Docker image for cross-compilation (~800MB download)
          desc: |
               Builds the Docker image needed for cross-compiling to any platform.
               Run this once to enable cross-platform builds from any OS.
          cmds:
             - docker build -t wails-cross -f build/docker/Dockerfile.cross build/docker/
          preconditions:
             - sh: docker info > /dev/null 2>&1
               msg: "Docker is required. Please install Docker first."
